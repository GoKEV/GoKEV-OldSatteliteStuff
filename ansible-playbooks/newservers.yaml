---
- name: MAIN | Deploying subtasks
  hosts: all
  remote_user: root

  vars:
    install_packages:
    - libselinux-python
    - nmap
    - nano
    - ntp
    - screen
    - sysstat

  tasks:
    - include: plays/motd_customize.yaml

    - include: plays/package_install.yaml

    - include: plays/users.yaml

    - include: plays/satellite-reg.yaml


## If we called for a reboot
    - name: reboot host RHEL6 if we call for a reboot
      command: sleep 5 ; /sbin/shutdown -r ; echo &
      when: ansible_os_family == "Redhat" and ansible_distribution_major_version == "6"
      when: rebootrequired is defined and rebootrequired == 'yes' and ansible_os_family == "Redhat" and ansible_distribution_major_version == "7"


    - name: reboot host RHEL7 if we call for a reboot
      command: /usr/bin/systemd-run --on-active=10 /usr/bin/systemctl reboot
      async: 0
      poll: 0
      when: rebootrequired is defined and rebootrequired == 'yes' and ansible_os_family == "Redhat" and ansible_distribution_major_version == "7"


    - name: wait for host sshd if we call for a reboot
      local_action: wait_for host="{{ inventory_hostname }}" search_regex=OpenSSH port=22 timeout=300 delay=90
      when: rebootrequired is defined and rebootrequired == 'yes' and ansible_os_family == "Redhat" 



